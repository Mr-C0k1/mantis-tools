import requests
import subprocess
import json
import os
import tempfile
from urllib.parse import urljoin

class MantisExploit:
    def __init__(self, target_ip, open_ports):
        self.target_ip = target_ip
        self.open_ports = open_ports
        self.found_vulns = []

    def run_semgrep(self, file_path):
        """Jalankan Semgrep pada file yang didownload untuk detect secrets/vulns tersembunyi"""
        try:
            # Gunakan --config=p/ci untuk fokus secrets + best practices (lebih akurat untuk .env)
            result = subprocess.run(
                ["semgrep", "--config=p/ci", "--json", "--quiet", file_path],
                capture_output=True, text=True, timeout=30
            )
            if result.returncode == 0 and result.stdout.strip():
                return json.loads(result.stdout).get("results", [])
            return []
        except subprocess.TimeoutExpired:
            print("Semgrep timeout pada file:", file_path)
            return []
        except Exception as e:
            print(f"Semgrep error: {e}")
            return []

    def check_exposure(self, base_url, file_path, vuln_type, scan_with_semgrep=False):
        url = urljoin(base_url, file_path)
        try:
            resp = requests.get(url, timeout=10, allow_redirects=True)  # allow_redirects=True biar ikut redirect
            if resp.status_code == 200 and resp.text.strip():  # Pastikan ada content
                vuln_detail = {
                    "type": vuln_type,
                    "url": url,
                    "severity": "CRITICAL" if "env" in file_path or "git" in file_path else "HIGH",
                    "details": "File exposed"
                }

                # Jika diminta scan dengan Semgrep (khusus file sensitif seperti .env, config, dll)
                if scan_with_semgrep:
                    # Simpan temporary file
                    with tempfile.NamedTemporaryFile(mode='w', suffix=os.path.basename(file_path), delete=False) as tmp:
                        tmp.write(resp.text)
                        tmp_path = tmp.name

                    findings = self.run_semgrep(tmp_path)
                    if findings:
                        vuln_detail["severity"] = "CRITICAL"
                        vuln_detail["details"] = f"Exposed + {len(findings)} potential secrets/vulns detected"
                        vuln_detail["semgrep_findings"] = findings  # Simpan detail untuk report

                    os.unlink(tmp_path)  # Hapus tmp file

                self.found_vulns.append(vuln_detail)
                return True
        except Exception as e:
            pass  # Silent fail seperti sebelumnya
        return False

    def start(self):
        web_ports = [p for p in self.open_ports if p in [80, 443, 8080, 8000, 3000, 5000]]  # Tambah port common lain
        exposures_to_check = [
            (".env", ".env Exposure", True),                  # Scan dengan Semgrep
            (".git/HEAD", "Git Directory Exposure", False),
            ("config.php", "Config File Exposure", True),
            ("wp-config.php", "WordPress Config Exposure", True),
            (".ds_store", ".DS_Store Exposure", False),
            ("backup.sql", "Database Backup Exposure", True),
        ]

        for port in web_ports:
            schema = "https" if port in [443, 8443] else "http"
            base_url = f"{schema}://{self.target_ip}:{port}/"

            for file_path, vuln_type, scan_semgrep in exposures_to_check:
                self.check_exposure(base_url, file_path, vuln_type, scan_with_semgrep)

        return self.found_vulns
